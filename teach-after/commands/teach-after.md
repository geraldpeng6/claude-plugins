---
description: 事后复盘教学 - 在功能实现或 bug 修复后进行系统性复盘与深入理解
argument-hint: "[复盘主题，如 'XXX bug' 或 'YYY 功能']"
allowed-tools: ["Read", "Grep", "Glob"]
---

# 事后复盘教学模式

你正在执行「事后复盘教学」流程。这是一个系统性的复盘工作流，目标是帮助用户深入理解刚刚完成的工作。

## 核心原则

- **以理解为目标，而非继续修改代码**：重点是「吃透」这次经历
- **完整地解释前因后果**：从需求/设想到实现/现象，再到最终结论
- **多用对比法**：失败 vs 成功、误解 vs 正解、直觉想法 vs 实际行为
- **显式指出可迁移经验**：不仅知道「这次怎么修」，还要知道「以后类似问题怎么想」

## 复盘主题

用户指定的复盘主题：$ARGUMENTS

如果用户未指定主题，请基于对话上下文自动识别最近完成的任务（bug 修复或功能实现）。

---

## 标准工作流

按以下 6 个步骤依次执行，每个步骤完成后用分隔线标记：

### 步骤 1：重建时间线

按时间顺序梳理整个过程：

1. **最初目标**：用户最开始想要实现什么？
2. **首次失败**：第一次遇到问题的具体表现（错误信息、异常行为）
3. **尝试过程**：期间尝试过哪些思路/修改？各自结果如何？
4. **最终方案**：最后生效的方案是什么？改了哪些关键点？

输出格式：
```
## 📅 时间线重建

**目标**：[描述]

**问题表现**：[错误信息/行为]

**尝试历程**：
1. [尝试1] → [结果]
2. [尝试2] → [结果]
...

**最终方案**：[关键改动点]
```

---

### 步骤 2：分析「为什么之前失败」

对每一类失败进行深入分析：

1. **根本原因**：
   - 理解错误？需求不清？
   - API/协议细节没注意？
   - 环境/版本问题？

2. **问题分类**：
   - 暂时性/偶发性问题 vs 本质性设计问题

3. **早期信号**：
   - 哪些信号（日志、报错、行为）本可以更早暴露原因？

输出格式：
```
## ❌ 失败原因分析

**根本原因**：[具体原因]

**问题类型**：[偶发性/本质性]

**被忽略的信号**：
- [信号1]：本可以提示 [什么]
- [信号2]：本可以提示 [什么]
```

### 步骤 3：解释「为什么后来成功」

用「因果关系」而不是「步骤列表」来说明：

1. **关键改动点**：每个改动分别解决了什么问题？
2. **对比分析**：和失败方案相比，多做/少做了什么？
3. **因果链条**：
   - 因为 A 的本质是 X，所以需要配置/代码中的 B
   - 之前之所以失败，是因为假设了 Y，但实际行为是 Z

输出格式：
```
## ✅ 成功原因解释

**关键改动**：
1. [改动1] → 解决了 [问题1]
2. [改动2] → 解决了 [问题2]

**对比**：
| 失败方案 | 成功方案 |
|---------|---------|
| [做法A] | [做法B] |

**因果链条**：
因为 [本质原因]，所以 [需要的做法]。
之前失败是因为 [错误假设]，但实际 [真实行为]。
```

### 步骤 4：深入讲解最终方案原理

从实现抽象出核心概念：

1. **核心概念/组件**：涉及到哪些关键概念？（如：事件循环、连接池、事务、序列化、缓存等）
2. **数据流/控制流**：谁先发生、谁触发谁、谁依赖谁
3. **代码解析**：逐段解释关键片段的作用和边界条件
4. **典型坑位**：指出常见问题（如：线程安全、时序问题、错误处理遗漏）

输出格式：
```
## 🔬 原理深入讲解

**核心概念**：
- [概念1]：[解释]
- [概念2]：[解释]

**流程图**：
[用文字或 ASCII 描述数据/控制流]

**关键代码解析**：
[代码片段] → [作用] → [边界条件]

**常见坑位**：
- [坑1]：[为什么容易出错]
- [坑2]：[为什么容易出错]
```

### 步骤 5：总结可迁移的经验

把这次问题抽象成可复用的「模式」：

1. **问题模式**：例如「环境不一致导致的 Bug」「错误理解库默认行为」「框架生命周期没搞清楚」
2. **Checklist**：下次遇到类似问题可以直接应用的检查清单
   - 先检查哪些配置/环境？
   - 看哪些日志/指标？
   - 用哪些调试手段？（断点、打印、mock、最小复现等）

输出格式：
```
## 📚 可迁移经验

**问题模式**：[模式名称]
- 特征：[如何识别这类问题]
- 本质：[为什么会出现]

**下次遇到类似问题的 Checklist**：
- [ ] 检查 [配置/环境1]
- [ ] 查看 [日志/指标1]
- [ ] 尝试 [调试手段1]
- [ ] ...
```

### 步骤 6：后续优化/重构建议（可选）

基于当前方案，给出未来改进方向：

1. **当前够用**：哪些地方已经够用，可以先不动？
2. **潜在隐患**：哪些地方在规模变大/流量变高/需求增加时会成为隐患？
3. **重构方向**：1-2 个更工程化的重构方向
4. **TODO 清单**：「以后有空可以改」的清单，而不是现在立刻动手

输出格式：
```
## 🚀 后续优化建议

**当前够用**：
- [部分1]：[为什么暂时不需要改]

**潜在隐患**：
- [隐患1]：当 [条件] 时可能出问题

**可选重构方向**：
1. [方向1]：[好处]
2. [方向2]：[好处]

**TODO（非紧急）**：
- [ ] [改进项1]
- [ ] [改进项2]
```

---

## 执行说明

1. 按顺序执行以上 6 个步骤
2. 每个步骤完成后，使用对应的输出格式
3. 如果某个步骤信息不足，可以询问用户补充
4. 步骤 6 是可选的，询问用户是否需要
5. 全程保持「教学」而非「修改代码」的心态
